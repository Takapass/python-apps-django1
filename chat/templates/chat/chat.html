<!-- {% extends "base.html" %} -->

<!-- {% block content %} -->
<!DOCTYPE html>
<html lang="ja">
<div class="chat-header">
    <a href="{% url 'room_list' %}" class="back-btn">&lt;Back</a>
    <span>{{ room.name }}</span>
</div>

<div class="chat-body">
    {% for m in messages %}
        {% if m.user == request.user %}
            <div class="message blue">{{ m.text }}</div>
        {% else %}
            <div class="message">{{ m.text }}</div>
        {% endif %}
    {% endfor %}
</div>

<form method="POST" action="{% url 'send_message' room.id %}" class="chat-input">
    {% csrf_token %}
    <input type="text" name="text" placeholder="メッセージを入力">
    <button type="submit">送信</button>
</form>

<script>
    const roomId = "{{ room.id }}";
    const ws = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomId + '/'
    );
    
    ws.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const div = document.createElement('div');
        div.textContent = data.username + ": " + data.message;
        div.className = data.username == "{{ request.user.username }}" ? "message blue" : "message";
        document.querySelector('.chat-body').appendChild(div);
    };
    
    function sendMessage() {
        const input = document.querySelector('input[name="text"]');
        ws.send(JSON.stringify({'message': input.value}));
        input.value = '';
    }
    </script>
    
<!-- {% endblock %} -->
